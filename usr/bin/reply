#!/usr/bin/env python

import getpass, keyring
import xmpp
import sys

USERNAME = "pavpanchekha"
PASSWORD = "-D*M|8FIL(0g"
#PASSWORD = keyring.get_password("Google Chat", USERNAME)
if not PASSWORD:
    PASSWORD = getpass.getpass("Google Chat Password: ")
    keyring.set_password("Google Chat", USERNAME, PASSWORD)

cnx = xmpp.Client("gmail.com", debug=[])
cnx.connect(server=("talk.google.com", 5223))
cnx.auth(USERNAME, PASSWORD, "msg-0.1")

def parse_contacts():
    return [l[:-1].split(" ", 2) for l in open("/home/pavpanchekha/usr/lib/chat/chat.contacts")]

def message(jid, text):
    print jid, text
    cnx.send(xmpp.protocol.Message(jid, text))

if sys.argv[0].endswith("reply"):
    sys.path.append("/home/pavpanchekha/usr/lib/chat")
    import lastnot
    nots = lastnot.parse(open("/home/pavpanchekha/.cache/notify-osd.log").read())
    nots = [n.title for n in nots if "Empathy" in n.process]
    name = nots[-1]
    
    for contact in parse_contacts():
        if contact[2] == name:
            jid = contact[1]
            break
    else:
        print "ERROR: No contact `%s` found" % name

    message(jid + "@gmail.com", " ".join(sys.argv[1:]))
else:
    for contact in parse_contacts():
        if contact[0] == sys.argv[1]:
            jid = contact[1]
            break
    else:
        jid = sys.argv[1]
    message(jid + "@gmail.com", " ".join(sys.argv[2:]))
