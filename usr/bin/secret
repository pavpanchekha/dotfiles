#!/usr/bin/python

import os, sys
SECRETFILE = "/home/pavpanchekha/priv/secrets"

def get_password(name):
    read_pw = False
    for line in open(SECRETFILE):
    	if line.startswith("Name") and line.split()[1] == name:
            read_pw = True
        elif line.startswith("Password") and read_pw:
            return line[line.index("\"")+1:line.rindex("\"")]
    raise ValueError("No such secret")

def generate_password(len=12):
    lower  = "abcdefghijklmnopqrstuvwxyz"
    upper  = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    number = "0123456789"
    chars  = "`~!@#$%^&*()_+-=?/>.<,|\\}]{[\"':;"

    import random
    passwd = random.choice(lower) + random.choice(upper) + random.choice(number) + random.choice(chars)

    valid = lower * 3 + upper * 3 + number * 5 + chars * 2
    for i in range(4, len):
        passwd += random.choice(valid)

    l = list(passwd)
    random.shuffle(l)
    return "".join(l)

def new_account(name, url):
    pwd = generate_password()
    with open(SECRETFILE, "a") as f:
    	f.write("\nName %s\n" % name)
        f.write("URL %s\n" % url)
        f.write("Password \"%s\"\n" % pwd)
    print "Your password is", pwd

def main():
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == "-n":
        assert len(sys.argv) == 4, "USAGE: secrets -n <name> <url>"
        new_account(sys.argv[2], sys.argv[3])
    else:
        assert len(sys.argv) == 2
        print get_password(sys.argv[1])

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "-h":
        print "Manage passwords"
        print
        print "USAGE: secret <name>		Print password for account <name>"
        print "     | secret -n <name> <url>	Create a new account <name> at <url> and print the new password"
    elif os.getuid() == 0:
        main()
    else:
        os.system("sudo /home/pavpanchekha/usr/bin/secret %s" % " ".join("\"" + s + "\"" for s in sys.argv[1:]))

