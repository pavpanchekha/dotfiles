#!/bin/bash

HOST="webcam@server"
UPPATH="/home/webcam/video/"

record () {
    if [[ "$1" == "-l" ]]; then
        LEN="$2"
        shift
        shift
    else
        LEN="1:00:00"
    fi

    FNAME="$1"

    ffmpeg -f video4linux2 -r 2 -s 640x480 -i /dev/video0 -t "$LEN" "$FNAME" > /dev/null 2>&1
    echo "$FNAME"
}

record15 () {
    NAME="/tmp/webcam-`date +'%b-%d-%H-%M'.mp4`"
    record -l 0:15:00 "$NAME"
}

upload () {
    FNAME="$1"

    scp "$FNAME" "$HOST":"$UPPATH" && rm "$FNAME"
}

ssh-add
while true; do
    upload `record15` &
done
