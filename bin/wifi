#!/bin/sh

down () {
    sudo dhcpcd -k
    sudo ip link set wlan0 down
}

connect_open () {
    NET="$1"
    sudo ip link set wlan0 up
    sudo iw wlan0 connect "$NET"
    sleep 0.5
    sudo dhcpcd -n
}

scan () {
    NET="$1" # If $1 is empty, this yields a strange argument list, but it still works
    sudo ip link set wlan0 up
    sudo iw wlan0 scan ssid "$NET"
}

scan_names () {
    NET="$1" # If $1 is empty, this yields a strange argument list, but it still works
    sudo ip link set wlan0 up
    sudo iw wlan0 scan ssid "$NET" | grep SSID | sort | uniq | grep -v "\\x00" | grep -v 'SSID:\s*$'
}

usage () {
cat <<EOF

USAGE: wifi -C <ssid>              Connect to <ssid>
     | wifi -D                     Take down wifi
     | wifi -S                     Scan for names

Connecting [-C]

    -f  Force connection; take down current connection,
        then connect to new network

Scanning [-S]

    -a  Print all data (signal strength, encryption, etc)

EOF
}

if [[ "$1" == "-h" ]]; then
    usage
elif [[ "$1" == "-d" ]]; then
    down
elif [[ "$1" == "-S" ]]; then
    scan_names "$2"
elif [[ "$1" == "-Sa" ]]; then
    scan "$2"
elif [[ "$1" == "-C" ]]; then
    connect_open "$@"
elif [[ "$1" == "-Cf" ]]; then
    shift
    down
    connect_open "$@"
else
    echo "Error: invalid command" >&2
    usage
fi
