#!/usr/bin/env python

__version__ = "0.9"
KEY = "79d213eb5a28c533cb0ad6404619c7d8"

import os, sys
import requests

api_host = "https://api.trello.com"
api_version = "1"

TOKEN = None
TOKEN_FILE = os.path.expanduser("~/.config/notepaster/key")

def url(*parts):
    return "/".join([api_host, api_version] + list(parts))

def authorize():
    global TOKEN
    
    if os.path.isfile(TOKEN_FILE):
        with open(TOKEN_FILE, mode="rt") as f:
            TOKEN = f.read().strip()
    else:
        data = {
            "key": KEY, "name": "Notepaster",
            "response_type": "token",
            "scope": "read,write"
        }
        
        # What do we do with this?
        raise NotImplementedError("Cannot request a token yet")

def get_list(user="me"):
    res = requests.get(url("members", user, "boards"),
                       params=dict(key=KEY, token=TOKEN, fields="id,name", lists="all", filter="open"),
                       headers=dict(accept="application/json"))

    for board in res.json():
        if board["name"] == "Notes":
            for list in board["lists"]:
                if list["name"] == "Inbox" and not list["closed"]:
                    return list["id"]
            else:
                raise NotImplementedError("Cannot find `Inbox` list")
    else:
        raise NotImplementedError("Cannot find `Notes` board")

def add_card(list, text):
    res =  requests.post(url("lists", list, "cards"),
                         data=dict(key=KEY, token=TOKEN,
                                   name=text, desc=text))
    if res.status_code != requests.codes.ok:
        print(res)
        sys.exit(100)

def get_clipboard():
    import subprocess

    proc = subprocess.Popen(["xclip", "-selection", "primary", "-o"],
                            stdout=subprocess.PIPE)
    out, err = proc.communicate()

    if err:
        print(err)
        sys.exit(100)

    return out.strip()

if __name__ == "__main__":
    authorize()
    add_card(get_list(), get_clipboard())
